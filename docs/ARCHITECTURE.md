# ğŸ—ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

> Enterprise CRM Systemì˜ ê¸°ìˆ ì  ì„¤ê³„ ë° êµ¬í˜„ ìƒì„¸

---

## ëª©ì°¨

1. [ì‹œìŠ¤í…œ ê°œìš”](#ì‹œìŠ¤í…œ-ê°œìš”)
2. [ê¸°ìˆ  ìŠ¤íƒ](#ê¸°ìˆ -ìŠ¤íƒ)
3. [ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„](#ë°ì´í„°ë² ì´ìŠ¤-ì„¤ê³„)
4. [ì¸ì¦ ì‹œìŠ¤í…œ](#ì¸ì¦-ì‹œìŠ¤í…œ)
5. [ê¶Œí•œ ê´€ë¦¬](#ê¶Œí•œ-ê´€ë¦¬)
6. [í•µì‹¬ íŒ¨í„´](#í•µì‹¬-íŒ¨í„´)
7. [API ì„¤ê³„](#api-ì„¤ê³„)
8. [ì„±ëŠ¥ ìµœì í™”](#ì„±ëŠ¥-ìµœì í™”)
9. [ë³´ì•ˆ](#ë³´ì•ˆ)

---

## ì‹œìŠ¤í…œ ê°œìš”

### ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    í´ë¼ì´ì–¸íŠ¸ (ë¸Œë¼ìš°ì €)                   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ê´€ë¦¬ì UI    â”‚  â”‚ ì˜ì—…ì‚¬ì› UI   â”‚  â”‚ ë¡œê·¸ì¸ UI     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Next.js 15 (App Router)                      â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Server Components (RSC)                         â”‚   â”‚
â”‚  â”‚  - ëŒ€ì‹œë³´ë“œ í˜ì´ì§€                                  â”‚
â”‚  â”‚  - ê³ ê° ê´€ë¦¬ í˜ì´ì§€                                 â”‚
â”‚  â”‚  - ì˜ì—…ì‚¬ì› ê´€ë¦¬ í˜ì´ì§€                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Client Components                                â”‚   â”‚
â”‚  â”‚  - ìƒë‹´ ê¸°ë¡ ëª¨ë‹¬                                    â”‚
â”‚  â”‚  - ë°ì´í„° ì—…ë¡œë“œ ì›Œí¬í”Œë¡œìš°                           â”‚
â”‚  â”‚  - ì‹¤ì‹œê°„ ì°¨íŠ¸ ë° í†µê³„                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  API Routes                                       â”‚   â”‚
â”‚  â”‚  - /api/admin/*                                   â”‚   â”‚
â”‚  â”‚  - /api/user/*                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“ REST API / Real-time
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Supabase (BaaS)                         â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚ Auth         â”‚  â”‚ Storage      â”‚   â”‚
â”‚  â”‚ Database     â”‚  â”‚ (JWT)        â”‚  â”‚ (ë¯¸ë˜)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë ˆì´ì–´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Presentation Layer               â”‚  â† UI ì»´í¬ë„ŒíŠ¸, í˜ì´ì§€
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Business Logic Layer             â”‚  â† ì„œë¹„ìŠ¤, ê¶Œí•œ, ìƒíƒœ ê´€ë¦¬
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Data Access Layer                â”‚  â† Supabase Client, API
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Database Layer                   â”‚  â† PostgreSQL (Supabase)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ê¸°ìˆ  ìŠ¤íƒ

### Frontend

| ê¸°ìˆ  | ë²„ì „ | ìš©ë„ |
|------|------|------|
| Next.js | 15.4.6 | í”„ë ˆì„ì›Œí¬ (App Router) |
| React | 19.1.0 | UI ë¼ì´ë¸ŒëŸ¬ë¦¬ |
| TypeScript | 5.x | íƒ€ì… ì•ˆì •ì„± |
| Tailwind CSS | v4 | ìŠ¤íƒ€ì¼ë§ |
| Zustand | 5.0.7 | ìƒíƒœ ê´€ë¦¬ (í´ë¼ì´ì–¸íŠ¸) |
| React Hook Form | 7.62.0 | í¼ ê²€ì¦ |
| Recharts | 3.1.2 | ì°¨íŠ¸ ë° ê·¸ë˜í”„ |
| Lucide React | 0.536.0 | ì•„ì´ì½˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ |
| XLSX | latest | ì—‘ì…€ import/export |

### Backend

| ê¸°ìˆ  | ìš©ë„ |
|------|------|
| Supabase | BaaS (Backend as a Service) |
| PostgreSQL | ë°ì´í„°ë² ì´ìŠ¤ |
| Supabase Auth | ì¸ì¦ (JWT) |
| Next.js API Routes | ì„œë²„ì‚¬ì´ë“œ ë¡œì§ |

### DevOps

| ê¸°ìˆ  | ìš©ë„ |
|------|------|
| Vercel | ë°°í¬ ë° í˜¸ìŠ¤íŒ… |
| Git | ë²„ì „ ê´€ë¦¬ |
| npm | íŒ¨í‚¤ì§€ ê´€ë¦¬ |

---

## ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

### ERD (Entity Relationship Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     users           â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK, UUID)       â”‚â—„â”€â”€â”€â”€â”€â”
â”‚ email               â”‚      â”‚
â”‚ full_name           â”‚      â”‚
â”‚ phone               â”‚      â”‚
â”‚ department          â”‚      â”‚
â”‚ role                â”‚      â”‚
â”‚ is_super_admin      â”‚      â”‚
â”‚ is_active           â”‚      â”‚
â”‚ created_at          â”‚      â”‚
â”‚ updated_at          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚                   â”‚
         â”‚ 1:N               â”‚
         â†“                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ lead_assignments    â”‚      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
â”‚ id (PK)             â”‚      â”‚
â”‚ lead_id (FK)        â”‚â”€â”€â”   â”‚
â”‚ counselor_id (FK)   â”‚  â”‚   â”‚
â”‚ assigned_by (FK)    â”‚â”€â”€â”˜   â”‚
â”‚ assigned_at         â”‚      â”‚
â”‚ status              â”‚      â”‚
â”‚ notes               â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
         â”‚                   â”‚
         â”‚ 1:1               â”‚
         â†“                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚     lead_pool       â”‚      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
â”‚ id (PK, UUID)       â”‚      â”‚
â”‚ phone (UNIQUE)      â”‚      â”‚
â”‚ contact_name        â”‚      â”‚
â”‚ real_name           â”‚      â”‚
â”‚ data_source         â”‚      â”‚
â”‚ contact_script      â”‚      â”‚
â”‚ data_date           â”‚      â”‚
â”‚ extra_info          â”‚      â”‚
â”‚ status              â”‚      â”‚
â”‚ created_at          â”‚      â”‚
â”‚ updated_at          â”‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚ counseling_activitiesâ”‚     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
â”‚ id (PK, UUID)       â”‚      â”‚
â”‚ assignment_id (FK)  â”‚â”€â”€â”€â”€â”€â”€â”˜
â”‚ contact_date        â”‚
â”‚ contact_method      â”‚
â”‚ actual_customer_nameâ”‚
â”‚ counseling_memo     â”‚
â”‚ investment_budget   â”‚
â”‚ customer_interest   â”‚
â”‚ contract_status     â”‚
â”‚ contract_amount     â”‚
â”‚ commission_amount   â”‚
â”‚ created_at          â”‚
â”‚ updated_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_permissions    â”‚      â”‚ department_permissionsâ”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)             â”‚      â”‚ id (PK)             â”‚
â”‚ user_id (FK)        â”‚      â”‚ user_id (FK)        â”‚
â”‚ permission_type     â”‚      â”‚ department          â”‚
â”‚ granted_by (FK)     â”‚      â”‚ granted_by (FK)     â”‚
â”‚ granted_at          â”‚      â”‚ granted_at          â”‚
â”‚ is_active           â”‚      â”‚ is_active           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” í…Œì´ë¸” ìƒì„¸

#### 1. users (ì‚¬ìš©ì)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT NOT NULL UNIQUE,
  full_name TEXT NOT NULL,
  phone TEXT,
  department TEXT,
  role TEXT NOT NULL CHECK (role IN ('admin', 'counselor')),
  is_super_admin BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_department ON users(department);
CREATE INDEX idx_users_is_active ON users(is_active);
```

**ì—­í• **:
- `admin`: ê´€ë¦¬ì (ì¼ë°˜ or ìµœê³ )
- `counselor`: ì˜ì—…ì‚¬ì›

#### 2. lead_pool (ê³ ê° ë°ì´í„°)

```sql
CREATE TABLE lead_pool (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  phone TEXT NOT NULL UNIQUE,
  contact_name TEXT,
  real_name TEXT,
  data_source TEXT,
  contact_script TEXT,
  data_date TEXT,
  extra_info TEXT,
  status TEXT NOT NULL DEFAULT 'available' CHECK (status IN ('available', 'assigned', 'completed', 'returned')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_lead_pool_phone ON lead_pool(phone);
CREATE INDEX idx_lead_pool_status ON lead_pool(status);
CREATE INDEX idx_lead_pool_created_at ON lead_pool(created_at DESC);
```

**ìƒíƒœ**:
- `available`: ë°°ì • ê°€ëŠ¥
- `assigned`: ë°°ì •ë¨
- `completed`: ê³„ì•½ ì™„ë£Œ
- `returned`: ë°˜í™˜ë¨

#### 3. lead_assignments (ë°°ì •)

```sql
CREATE TABLE lead_assignments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  lead_id UUID NOT NULL REFERENCES lead_pool(id) ON DELETE CASCADE,
  counselor_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  assigned_by UUID REFERENCES users(id),
  assigned_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'working', 'completed', 'returned')),
  notes TEXT
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_assignments_counselor ON lead_assignments(counselor_id);
CREATE INDEX idx_assignments_lead ON lead_assignments(lead_id);
CREATE INDEX idx_assignments_status ON lead_assignments(status);
```

#### 4. counseling_activities (ìƒë‹´ ê¸°ë¡)

```sql
CREATE TABLE counseling_activities (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  assignment_id UUID NOT NULL REFERENCES lead_assignments(id) ON DELETE CASCADE,
  contact_date DATE NOT NULL,
  contact_method TEXT,
  actual_customer_name TEXT,
  counseling_memo TEXT,
  investment_budget TEXT,
  customer_interest TEXT,
  contract_status TEXT DEFAULT 'pending' CHECK (contract_status IN ('pending', 'contracted', 'failed')),
  contract_amount NUMERIC(15, 2),
  commission_amount NUMERIC(15, 2),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_activities_assignment ON counseling_activities(assignment_id);
CREATE INDEX idx_activities_contact_date ON counseling_activities(contact_date DESC);
CREATE INDEX idx_activities_contract_status ON counseling_activities(contract_status);
```

#### 5. user_permissions (ê¶Œí•œ)

```sql
CREATE TABLE user_permissions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  permission_type TEXT NOT NULL,
  granted_by UUID REFERENCES users(id),
  granted_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  is_active BOOLEAN DEFAULT true,
  UNIQUE(user_id, permission_type)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_permissions_user ON user_permissions(user_id);
CREATE INDEX idx_permissions_type ON user_permissions(permission_type);
```

**ê¶Œí•œ íƒ€ì…**:
- `assignments`: ë°°ì • ê´€ë¦¬
- `consulting_monitor`: ìƒë‹´ ëª¨ë‹ˆí„°ë§
- `counselors`: ì˜ì—…ì‚¬ì› ê´€ë¦¬
- `dashboard`: ëŒ€ì‹œë³´ë“œ
- `leads`: ë¦¬ë“œ ê´€ë¦¬
- `settings`: ì‹œìŠ¤í…œ ì„¤ì •
- `upload`: ë°ì´í„° ì—…ë¡œë“œ
- `phone_unmask`: ì „í™”ë²ˆí˜¸ ë§ˆìŠ¤í‚¹ í•´ì œ

---

## ì¸ì¦ ì‹œìŠ¤í…œ

### v8 AuthContext ì•„í‚¤í…ì²˜

**íŒŒì¼**: `src/lib/auth/AuthContext.tsx`

#### í•µì‹¬ ê¸°ëŠ¥

1. **í”„ë¡œí•„ ë¡œë“œ ì¬ì‹œë„ ë¡œì§**
   ```typescript
   const fetchUserProfile = async (userId: string, retryCount = 0) => {
     try {
       const { data, error } = await supabase
         .from('users')
         .select('*')
         .eq('id', userId)
         .single();

       if (error && retryCount < 2) {
         await new Promise(resolve => setTimeout(resolve, 1000));
         return fetchUserProfile(userId, retryCount + 1);
       }

       return data;
     } catch (error) {
       // ì—ëŸ¬ ì²˜ë¦¬
     }
   };
   ```

2. **8ì´ˆ íƒ€ì„ì•„ì›ƒ + ìë™ ì¬ì‹œë„**
   ```typescript
   const loadUserWithTimeout = Promise.race([
     loadUser(),
     new Promise((_, reject) =>
       setTimeout(() => reject(new Error('Timeout')), 8000)
     )
   ]);
   ```

3. **ìŠ¤ë§ˆíŠ¸ ë¦¬ë‹¤ì´ë ‰íŠ¸**
   - í™ˆí˜ì´ì§€(`/`)ì™€ ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œë§Œ ë¦¬ë‹¤ì´ë ‰íŠ¸
   - ë¬´í•œ ë£¨í”„ ë°©ì§€

4. **í† í° ê°±ì‹  ì•ˆì •í™”**
   ```typescript
   supabase.auth.onAuthStateChange((event, session) => {
     if (event === 'TOKEN_REFRESHED') {
       // ì„¸ì…˜ ì—…ë°ì´íŠ¸
     }
   });
   ```

### ì¸ì¦ í”Œë¡œìš°

```
1. ì‚¬ìš©ì ë¡œê·¸ì¸ (ì´ë©”ì¼ + ë¹„ë°€ë²ˆí˜¸)
   â†“
2. Supabase Auth ê²€ì¦
   â†“
3. JWT í† í° ë°œê¸‰
   â†“
4. users í…Œì´ë¸”ì—ì„œ í”„ë¡œí•„ ì¡°íšŒ (ìµœëŒ€ 2íšŒ ì¬ì‹œë„)
   â†“
5. ê¶Œí•œ ì •ë³´ ë¡œë“œ (user_permissions, department_permissions)
   â†“
6. AuthContextì— ì €ì¥
   â†“
7. ì—­í• ë³„ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
   - admin â†’ /admin/dashboard
   - counselor â†’ /counselor/dashboard
```

---

## ê¶Œí•œ ê´€ë¦¬

### 3ë‹¨ê³„ ì—­í•  ì²´ê³„

```
ìµœê³ ê´€ë¦¬ì (is_super_admin = true)
  â”œâ”€ ëª¨ë“  ê¶Œí•œ ìë™ ë¶€ì—¬
  â”œâ”€ ê¶Œí•œ ë¶€ì—¬/í•´ì œ ê°€ëŠ¥
  â””â”€ ì‚­ì œ ë¶ˆê°€

ì¼ë°˜ê´€ë¦¬ì (role = 'admin', is_super_admin = false)
  â”œâ”€ user_permissions ê¸°ë°˜ ê¶Œí•œ
  â”œâ”€ ë¶€ì„œë³„ ì ‘ê·¼ ì œì–´
  â””â”€ ì†Œí”„íŠ¸ ì‚­ì œ ê°€ëŠ¥

ì˜ì—…ì‚¬ì› (role = 'counselor')
  â”œâ”€ ìì‹ ì˜ ë°ì´í„°ë§Œ ì ‘ê·¼
  â”œâ”€ ë°°ì •ëœ ê³ ê°ë§Œ ì¡°íšŒ
  â””â”€ ìƒë‹´ ê¸°ë¡ ì…ë ¥
```

### ê¶Œí•œ í™•ì¸ ë¡œì§

**íŒŒì¼**: `src/lib/services/permissions.ts`

```typescript
export const checkPermission = async (
  userId: string,
  permissionType: PermissionType
): Promise<boolean> => {
  // 1. ìµœê³ ê´€ë¦¬ì í™•ì¸
  const { data: user } = await supabase
    .from('users')
    .select('is_super_admin, role')
    .eq('id', userId)
    .single();

  if (user?.is_super_admin) {
    return true; // ìµœê³ ê´€ë¦¬ìëŠ” ëª¨ë“  ê¶Œí•œ
  }

  // 2. ì¼ë°˜ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
  if (user?.role === 'admin') {
    const { data: permission } = await supabase
      .from('user_permissions')
      .select('*')
      .eq('user_id', userId)
      .eq('permission_type', permissionType)
      .eq('is_active', true)
      .single();

    return !!permission;
  }

  // 3. ì˜ì—…ì‚¬ì›ì€ ê¶Œí•œ ì—†ìŒ
  return false;
};
```

### ë¶€ì„œ ê¶Œí•œ ì‹œìŠ¤í…œ

**íŒŒì¼**: `src/lib/services/departmentPermissions.ts`

```typescript
// ê´€ë¦¬ìê°€ ì ‘ê·¼ ê°€ëŠ¥í•œ ë¶€ì„œ ëª©ë¡
export const getAllowedDepartments = (userId: string): string[] => {
  // 1. ë³¸ì¸ ë¶€ì„œëŠ” ê¸°ë³¸ ì ‘ê·¼
  const userDepartment = getCurrentUserDepartment();

  // 2. DBì—ì„œ ì¶”ê°€ ê¶Œí•œ ì¡°íšŒ
  const { data: permissions } = await supabase
    .from('department_permissions')
    .select('department')
    .eq('user_id', userId)
    .eq('is_active', true);

  // 3. í†µí•© ë°˜í™˜
  return [userDepartment, ...permissions.map(p => p.department)];
};
```

---

## í•µì‹¬ íŒ¨í„´

### 1. v6 ë°ì´í„° ì§‘ê³„ íŒ¨í„´ (ì¤‘ë³µ ë°©ì§€)

**ë¬¸ì œ**:
- 1ê°œì˜ assignmentê°€ ì—¬ëŸ¬ ê°œì˜ ìƒë‹´ê¸°ë¡(counseling_activities)ì„ ê°€ì§ˆ ìˆ˜ ìˆìŒ
- `flatMap().reduce()`ë¡œ ì§‘ê³„ ì‹œ assignmentê°€ ì¤‘ë³µ ì¹´ìš´íŠ¸ë¨

**í•´ê²°ì±…**:
```typescript
// âŒ ì˜ëª»ëœ ë°©ë²• (ì¤‘ë³µ ë°œìƒ)
const totalContracts = assignments.flatMap(a => a.counseling_activities)
  .filter(activity => activity.contract_status === 'contracted')
  .length;

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²• (v6 íŒ¨í„´)
const totalContracts = assignments.filter(assignment => {
  const activities = assignment.counseling_activities;
  if (!activities || activities.length === 0) return false;

  // assignmentë³„ ìµœì‹  ê¸°ë¡ë§Œ í™•ì¸
  const latestActivity = activities.sort(
    (a, b) => new Date(b.contact_date) - new Date(a.contact_date)
  )[0];

  return latestActivity?.contract_status === 'contracted';
}).length;
```

### 2. ì„œë²„ì‚¬ì´ë“œ í˜ì´ì§•

**ì„±ëŠ¥ ë¬¸ì œ**: ê³ ê° ë°ì´í„°ê°€ 10,000ê±´ ì´ìƒì¼ ë•Œ í•œ ë²ˆì— ë¡œë“œ ì‹œ ë©”ëª¨ë¦¬ ë¶€ì¡±

**í•´ê²°ì±…**:
```typescript
const PAGE_SIZE = 50;

const fetchLeads = async (page: number) => {
  const startIndex = page * PAGE_SIZE;
  const endIndex = startIndex + PAGE_SIZE - 1;

  const { data, count } = await supabase
    .from('lead_pool')
    .select('*', { count: 'exact' })
    .range(startIndex, endIndex)
    .order('created_at', { ascending: false });

  return {
    leads: data,
    totalCount: count,
    totalPages: Math.ceil(count / PAGE_SIZE)
  };
};
```

### 3. ë©”ëª¨ íˆìŠ¤í† ë¦¬ (ë¬´í•œ ìŠ¤íƒ)

**ë°ì´í„° êµ¬ì¡°**:
```typescript
interface MemoHistory {
  content: string;
  timestamp: string;
  author: string;
}

// counseling_memoë¥¼ JSON ë°°ì—´ë¡œ ì €ì¥
counseling_memo: JSON.stringify([
  {
    content: "ì²« ë²ˆì§¸ ë©”ëª¨",
    timestamp: "2024-01-01T10:00:00Z",
    author: "ê¹€ì˜ì—…"
  },
  {
    content: "ë‘ ë²ˆì§¸ ë©”ëª¨ (ìˆ˜ì •)",
    timestamp: "2024-01-02T14:30:00Z",
    author: "ê¹€ì˜ì—…"
  }
])
```

### 4. ë””ìì¸ ì‹œìŠ¤í…œ

**íŒŒì¼**: `src/lib/design-system/index.ts`

```typescript
// ìƒ‰ìƒ ë³€ìˆ˜ (2rule.md ì¤€ìˆ˜)
export const COLORS = {
  text: {
    primary: 'text-gray-900 dark:text-gray-100',
    secondary: 'text-gray-600 dark:text-gray-400',
    tertiary: 'text-gray-500 dark:text-gray-500',
  },
  bg: {
    primary: 'bg-white dark:bg-gray-900',
    secondary: 'bg-gray-50 dark:bg-gray-800',
    tertiary: 'bg-gray-100 dark:bg-gray-700',
    hover: 'hover:bg-gray-100 dark:hover:bg-gray-800',
  },
  border: {
    primary: 'border-gray-200 dark:border-gray-700',
    secondary: 'border-gray-300 dark:border-gray-600',
  },
  status: {
    accent: 'bg-blue-100 text-blue-800',
    success: 'bg-green-100 text-green-800',
    warning: 'bg-yellow-100 text-yellow-800',
    error: 'bg-red-100 text-red-800',
  }
};
```

---

## API ì„¤ê³„

### RESTful API ì—”ë“œí¬ì¸íŠ¸

#### ê´€ë¦¬ì API

| Method | Endpoint | ì„¤ëª… | ê¶Œí•œ |
|--------|----------|------|------|
| POST | `/api/admin/create-user` | ì‚¬ìš©ì ìƒì„± | admin |
| PATCH | `/api/admin/update-user` | ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • | admin |
| DELETE | `/api/admin/delete-user` | ì†Œí”„íŠ¸ ì‚­ì œ | admin |
| DELETE | `/api/admin/permanently-delete-user` | ì˜êµ¬ ì‚­ì œ | super_admin |
| POST | `/api/admin/restore-user` | ì‚­ì œ ë³µêµ¬ | admin |
| POST | `/api/admin/reset-password` | ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” | admin |

#### ì‚¬ìš©ì API

| Method | Endpoint | ì„¤ëª… | ê¶Œí•œ |
|--------|----------|------|------|
| PATCH | `/api/user/update-profile` | í”„ë¡œí•„ ìˆ˜ì • | user |

### API ì‘ë‹µ í˜•ì‹

**ì„±ê³µ ì‘ë‹µ**:
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "email": "user@example.com"
  },
  "message": "ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
}
```

**ì—ëŸ¬ ì‘ë‹µ**:
```json
{
  "success": false,
  "error": "PERMISSION_DENIED",
  "message": "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.",
  "details": {
    "required": "admin",
    "current": "counselor"
  }
}
```

---

## ì„±ëŠ¥ ìµœì í™”

### 1. React Server Components (RSC)

- ëŒ€ì‹œë³´ë“œ í†µê³„: ì„œë²„ì—ì„œ ê³„ì‚° í›„ HTML ì „ì†¡
- ì´ˆê¸° ë¡œë”© ì†ë„ 50% ê°œì„ 

### 2. ìŠ¤ë§ˆíŠ¸ ìºì‹±

```typescript
// localStorage + sessionStorage ì´ì¤‘ ì €ì¥
const cachePermissions = (userId: string, permissions: Permission[]) => {
  const cacheData = {
    permissions,
    timestamp: Date.now(),
    expiresIn: 3600000 // 1ì‹œê°„
  };

  localStorage.setItem(`permissions_${userId}`, JSON.stringify(cacheData));
  sessionStorage.setItem(`permissions_${userId}`, JSON.stringify(cacheData));
};
```

### 3. ì§€ì—° ë¡œë”©

```typescript
// ë™ì  importë¡œ í•„ìš”í•œ ì»´í¬ë„ŒíŠ¸ë§Œ ë¡œë“œ
const DataUploadModal = dynamic(() => import('./DataUploadModal'), {
  loading: () => <LoadingSpinner />,
  ssr: false
});
```

### 4. ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ì‹±

```sql
-- ìì£¼ ì¡°íšŒë˜ëŠ” ì¹¼ëŸ¼ì— ì¸ë±ìŠ¤
CREATE INDEX idx_lead_pool_phone ON lead_pool(phone);
CREATE INDEX idx_assignments_counselor ON lead_assignments(counselor_id);
CREATE INDEX idx_activities_contract_status ON counseling_activities(contract_status);
```

---

## ë³´ì•ˆ

### 1. ì „í™”ë²ˆí˜¸ ë§ˆìŠ¤í‚¹

```typescript
const maskPhone = (phone: string): string => {
  if (phone.length < 4) return phone;
  return phone.slice(0, 3) + '****' + phone.slice(-4);
};

// ê¶Œí•œ ìˆëŠ” ì‚¬ìš©ìë§Œ í•´ì œ ê°€ëŠ¥
const unmaskedPhone = hasPermission('phone_unmask') ? phone : maskPhone(phone);
```

### 2. ì†Œí”„íŠ¸ ì‚­ì œ

```sql
-- is_active í”Œë˜ê·¸ë¡œ ì‚­ì œ í‘œì‹œ
UPDATE users SET is_active = false WHERE id = 'uuid';

-- ì‹¤ì œ ë°ì´í„°ëŠ” ë³´ì¡´
SELECT * FROM users WHERE id = 'uuid'; -- ì—¬ì „íˆ ì¡´ì¬

-- ë³µêµ¬ ê°€ëŠ¥
UPDATE users SET is_active = true WHERE id = 'uuid';
```

### 3. Row Level Security (RLS) - ì¤€ë¹„ ì¤‘

```sql
-- ì˜ì—…ì‚¬ì›ì€ ìì‹ ì˜ ë°°ì •ë§Œ ì¡°íšŒ
CREATE POLICY counselor_own_assignments ON lead_assignments
  FOR SELECT
  USING (counselor_id = auth.uid());

-- ê´€ë¦¬ìëŠ” ëª¨ë“  ë°°ì • ì¡°íšŒ
CREATE POLICY admin_all_assignments ON lead_assignments
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users
      WHERE users.id = auth.uid()
      AND users.role = 'admin'
    )
  );
```

### 4. í™˜ê²½ ë³€ìˆ˜ ë³´ì•ˆ

```bash
# .env.local (ì ˆëŒ€ ì»¤ë°‹í•˜ì§€ ì•ŠìŒ)
NEXT_PUBLIC_SUPABASE_URL=...
NEXT_PUBLIC_SUPABASE_ANON_KEY=...
SUPABASE_SERVICE_ROLE_KEY=... # ì„œë²„ì—ì„œë§Œ ì‚¬ìš©
```

---

## í–¥í›„ ê°œì„  ê³„íš

### Phase 1: ì‹¤ì‹œê°„ ê¸°ëŠ¥
- Supabase Realtimeìœ¼ë¡œ ì‹¤ì‹œê°„ ì•Œë¦¼
- ìƒˆ ë°°ì • ì‹œ ì˜ì—…ì‚¬ì›ì—ê²Œ í‘¸ì‹œ ì•Œë¦¼

### Phase 2: AI í†µí•©
- ìƒë‹´ ë©”ëª¨ ìë™ ìš”ì•½ (GPT-4)
- ë¦¬ë“œ ìŠ¤ì½”ì–´ë§ (ê³„ì•½ ê°€ëŠ¥ì„± ì˜ˆì¸¡)
- ìŒì„± â†’ í…ìŠ¤íŠ¸ ìë™ ì „ì‚¬

### Phase 3: ëª¨ë°”ì¼
- React Native ì•± ê°œë°œ
- ì˜¤í”„ë¼ì¸ ëª¨ë“œ ì§€ì›

### Phase 4: ê³ ê¸‰ ë¶„ì„
- ì˜ˆì¸¡ ë¶„ì„ (ë§¤ì¶œ ì˜ˆì¸¡)
- A/B í…ŒìŠ¤íŒ… í”Œë«í¼
- ì»¤ìŠ¤í…€ ë¦¬í¬íŠ¸ ë¹Œë”

---

## ì°¸ê³  ìë£Œ

- [Next.js ê³µì‹ ë¬¸ì„œ](https://nextjs.org/docs)
- [Supabase ê³µì‹ ë¬¸ì„œ](https://supabase.com/docs)
- [PostgreSQL ìµœì í™” ê°€ì´ë“œ](https://www.postgresql.org/docs/)
- [React 19 ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸](https://react.dev/blog/2024/04/25/react-19)

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-11-04
**ì‘ì„±ì**: [Your Name]
